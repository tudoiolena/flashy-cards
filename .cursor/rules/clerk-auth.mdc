---
alwaysApply: true
---
# Clerk Authentication and Authorization

All authentication in this project is handled by Clerk. It is **critical** that users can only access their own data and cannot access any data that does not belong to them.

## Authentication Setup

- Clerk middleware is configured in [src/middleware.ts](mdc:src/middleware.ts)
- ClerkProvider wraps the app in [src/app/layout.tsx](mdc:src/app/layout.tsx)
- User IDs are stored as Clerk user IDs (varchar) in the database schema

## Database Schema

The database schema in [src/db/schema.ts](mdc:src/db/schema.ts) uses `userId` fields to associate data with users:
- **decksTable**: Has `userId` field storing Clerk user ID
- **cardsTable**: Linked to decks via `deckId` (cascade delete)

## Requirements

### 1. Always Verify Authentication

**In API Routes (Route Handlers):**
```typescript
import { auth } from "@clerk/nextjs/server";

export async function GET() {
  const { userId } = await auth();
  
  if (!userId) {
    return new Response("Unauthorized", { status: 401 });
  }
  
  // Proceed with authenticated user
}
```

**In Server Components:**
```typescript
import { auth } from "@clerk/nextjs/server";

export default async function MyComponent() {
  const { userId } = await auth();
  
  if (!userId) {
    redirect("/sign-in");
  }
  
  // Proceed with authenticated user
}
```

**In Server Actions:**
```typescript
"use server";
import { auth } from "@clerk/nextjs/server";

export async function myAction() {
  const { userId } = await auth();
  
  if (!userId) {
    throw new Error("Unauthorized");
  }
  
  // Proceed with authenticated user
}
```

### 2. Always Filter by User ID

**NEVER** query data without filtering by `userId`. Every database query that retrieves user-specific data MUST include a `userId` filter.

```typescript
import { auth } from "@clerk/nextjs/server";
import { db } from "@/db";
import { decksTable, cardsTable } from "@/db/schema";
import { eq } from "drizzle-orm";

// ✅ CORRECT: Filter by userId
const { userId } = await auth();
if (!userId) {
  return new Response("Unauthorized", { status: 401 });
}

const decks = await db
  .select()
  .from(decksTable)
  .where(eq(decksTable.userId, userId));

// ❌ WRONG: Missing userId filter
const decks = await db.select().from(decksTable);
```

### 3. Verify Ownership Before Operations

**Before updating or deleting**, always verify the resource belongs to the current user:

```typescript
import { auth } from "@clerk/nextjs/server";
import { db } from "@/db";
import { decksTable } from "@/db/schema";
import { eq, and } from "drizzle-orm";

export async function DELETE(request: Request) {
  const { userId } = await auth();
  if (!userId) {
    return new Response("Unauthorized", { status: 401 });
  }
  
  const { deckId } = await request.json();
  
  // Verify ownership
  const deck = await db
    .select()
    .from(decksTable)
    .where(and(
      eq(decksTable.id, deckId),
      eq(decksTable.userId, userId)
    ))
    .limit(1);
  
  if (deck.length === 0) {
    return new Response("Not found or unauthorized", { status: 404 });
  }
  
  // Now safe to delete
  await db
    .delete(decksTable)
    .where(eq(decksTable.id, deckId));
}
```

### 4. For Cards, Verify Through Deck Ownership

Since cards belong to decks, verify deck ownership before accessing cards:

```typescript
import { auth } from "@clerk/nextjs/server";
import { db } from "@/db";
import { decksTable, cardsTable } from "@/db/schema";
import { eq, and } from "drizzle-orm";

const { userId } = await auth();
if (!userId) {
  return new Response("Unauthorized", { status: 401 });
}

// Verify deck ownership before accessing cards
const deck = await db
  .select()
  .from(decksTable)
  .where(and(
    eq(decksTable.id, deckId),
    eq(decksTable.userId, userId)
  ))
  .limit(1);

if (deck.length === 0) {
  return new Response("Deck not found or unauthorized", { status: 404 });
}

// Now safe to query cards for this deck
const cards = await db
  .select()
  .from(cardsTable)
  .where(eq(cardsTable.deckId, deckId));
```

### 5. Always Set userId on Creation

When creating new resources, **always** set the `userId` from the authenticated user:

```typescript
import { auth } from "@clerk/nextjs/server";
import { db } from "@/db";
import { decksTable } from "@/db/schema";

const { userId } = await auth();
if (!userId) {
  return new Response("Unauthorized", { status: 401 });
}

await db.insert(decksTable).values({
  userId: userId, // ✅ Always set from authenticated user
  title: "My Deck",
  description: "Description",
});
```

## Security Checklist

Before committing any code that accesses user data, verify:

- [ ] Authentication is checked (`await auth()` and `userId` verification)
- [ ] All SELECT queries filter by `userId` or verify ownership
- [ ] All UPDATE/DELETE operations verify ownership first
- [ ] All INSERT operations set `userId` from authenticated user
- [ ] Cards are accessed only after verifying deck ownership
- [ ] No raw queries bypass authorization checks
- [ ] Error messages don't leak information about data existence

## Common Mistakes to Avoid

1. **❌ Querying without userId filter**: `db.select().from(decksTable)`
2. **❌ Trusting client-provided userId**: Always use `await auth()` to get userId
3. **❌ Skipping ownership verification**: Always check before update/delete
4. **❌ Exposing other users' data**: Ensure all queries are scoped to current user
5. **❌ Using user input directly in queries**: Use parameterized queries (Drizzle handles this)

## Example: Complete API Route

```typescript
import { auth } from "@clerk/nextjs/server";
import { db } from "@/db";
import { decksTable } from "@/db/schema";
import { eq } from "drizzle-orm";
import { NextResponse } from "next/server";

export async function GET(request: Request) {
  // 1. Authenticate
  const { userId } = await auth();
  if (!userId) {
    return NextResponse.json({ error: "Unauthorized" }, { status: 401 });
  }
  
  // 2. Query with userId filter
  const decks = await db
    .select()
    .from(decksTable)
    .where(eq(decksTable.userId, userId));
  
  return NextResponse.json(decks);
}

export async function POST(request: Request) {
  // 1. Authenticate
  const { userId } = await auth();
  if (!userId) {
    return NextResponse.json({ error: "Unauthorized" }, { status: 401 });
  }
  
  // 2. Get request data
  const body = await request.json();
  
  // 3. Create with authenticated userId
  const [deck] = await db
    .insert(decksTable)
    .values({
      userId: userId,
      title: body.title,
      description: body.description,
    })
    .returning();
  
  return NextResponse.json(deck);
}
```
